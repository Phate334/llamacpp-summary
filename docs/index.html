<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>llama.cpp Daily Summary</title>
    <style>
        :root {
            color-scheme: light dark;
            --bg: #0b0f19;
            --panel: #121827;
            --text: #e8ecf3;
            --muted: #98a2b3;
            --accent: #7dd3fc;
            --border: #1f2a44;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        header {
            padding: 18px 24px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #0b0f19 0%, #0b0f19 70%, #0a1020 100%);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(8px);
        }

        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        header h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        header p {
            margin: 0;
            color: var(--muted);
            font-size: 13px;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(220px, 260px) 1fr;
            gap: 20px;
            align-items: start;
        }

        aside {
            border: 1px solid var(--border);
            border-radius: 14px;
            background: var(--panel);
            padding: 16px;
            height: fit-content;
            position: sticky;
            top: 72px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sidebar-title {
            margin: 0;
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .sidebar-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }


        .year-group {
            margin-bottom: 16px;
        }

        .year-group h3 {
            margin: 0 0 8px;
            font-size: 13px;
            color: var(--text);
            letter-spacing: 0.04em;
        }

        .month-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .month-chip {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid transparent;
            background: #0b1222;
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .month-chip:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .month-chip.active {
            border-color: var(--accent);
            background: #18233b;
            color: #eaf7ff;
            font-weight: 700;
        }

        .status {
            color: var(--muted);
            font-size: 12px;
        }

        .month-scroller {
            max-height: 420px;
            overflow: auto;
            padding-right: 4px;
        }

        .month-scroller::-webkit-scrollbar {
            width: 6px;
        }

        .month-scroller::-webkit-scrollbar-thumb {
            background: #1f2a44;
            border-radius: 999px;
        }

        .day-card {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            background: var(--panel);
            margin-bottom: 16px;
        }

        .day-card h2 {
            margin: 0 0 8px;
            font-size: 18px;
        }

        .release {
            border-top: 1px dashed var(--border);
            padding-top: 12px;
            margin-top: 12px;
        }

        .release h3 {
            margin: 0 0 6px;
            font-size: 15px;
            color: var(--accent);
        }

        .release time {
            font-size: 12px;
            color: var(--muted);
        }

        .release p {
            white-space: pre-wrap;
            margin: 8px 0 0;
            color: var(--text);
            line-height: 1.55;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            gap: 12px;
        }

        .results-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .month-pill {
            padding: 6px 12px;
            border-radius: 999px;
            background: #0f172a;
            border: 1px solid var(--border);
            color: var(--muted);
            font-size: 12px;
        }

        .empty {
            padding: 32px;
            text-align: center;
            color: var(--muted);
            border: 1px dashed var(--border);
            border-radius: 12px;
        }

        a {
            color: var(--accent);
        }
    </style>
</head>

<body>
    <header>
        <div class="header-inner">
            <div>
                <h1>llama.cpp Daily Summary</h1>
                <p>Browse daily release summaries by month from JSON files hosted on GitHub Pages.</p>
            </div>
            <div class="month-pill" id="current-month">Latest month</div>
        </div>
    </header>

    <main>
        <div class="layout">
            <aside>
                <div class="sidebar-meta">
                    <div class="sidebar-title">Months</div>
                    <div class="status" id="status">Loading months...</div>
                </div>
                <nav id="sidebar" class="month-scroller"></nav>
            </aside>
            <section id="results">
                <div class="results-header">
                    <h2>Daily summaries</h2>
                    <div class="month-pill" id="results-month">--</div>
                </div>
            </section>
        </div>
    </main>

    <script>
        const owner = 'Phate334';
        const repo = 'llamacpp-summary';
        const branch = 'main';
        const docsPath = 'docs';

        const statusEl = document.getElementById('status');
        const resultsEl = document.getElementById('results');
        const sidebarEl = document.getElementById('sidebar');
        const currentMonthEl = document.getElementById('current-month');
        const resultsMonthEl = document.getElementById('results-month');

        let activeButton = null;

        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderBodyHtml(text) {
            const escaped = escapeHtml(text || '');
            const prBase = 'https://github.com/ggml-org/llama.cpp/pull/';
            const linked = escaped.replace(/(^|\s)#(\d+)\b/g, (_, prefix, num) => {
                return `${prefix}<a href="${prBase}${num}" target="_blank" rel="noopener noreferrer">#${num}</a>`;
            });
            return linked.replace(/\n/g, '<br>');
        }

        async function loadMonth(year, month) {
            setStatus('Loading...');
            updateMonthLabels(year, month);
            clearResults();

            let files;
            try {
                files = await listJsonFiles(year, month);
            } catch (err) {
                setStatus(`Load failed: ${err.message}`);
                return;
            }

            if (!files.length) {
                resultsEl.appendChild(buildEmptyCard('No data for this month.'));
                setStatus('Done');
                return;
            }

            for (const file of files) {
                try {
                    const data = await fetchJsonFile(year, month, file.name);
                    renderDayCard(file.name, data);
                } catch (err) {
                    renderErrorCard(file.name, err);
                }
            }

            setStatus(`Done: ${files.length} days`);
        }

        function setStatus(text) {
            statusEl.textContent = text;
        }

        function updateMonthLabels(year, month) {
            const label = `${year}-${month}`;
            if (currentMonthEl) currentMonthEl.textContent = label;
            if (resultsMonthEl) resultsMonthEl.textContent = label;
        }

        function clearResults() {
            const header = resultsEl.querySelector('.results-header');
            resultsEl.innerHTML = '';
            if (header) resultsEl.appendChild(header);
        }

        function buildEmptyCard(message) {
            const empty = document.createElement('div');
            empty.className = 'empty';
            empty.textContent = message;
            return empty;
        }

        async function listJsonFiles(year, month) {
            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${docsPath}/${year}/${month}?ref=${branch}`;
            const res = await fetch(apiUrl, { headers: { 'Accept': 'application/vnd.github+json' } });
            if (res.status === 404) return [];
            if (!res.ok) throw new Error(`GitHub API error (${res.status})`);
            const data = await res.json();
            if (!Array.isArray(data)) return [];
            return data
                .filter(item => item.type === 'file' && item.name.endsWith('.json'))
                .sort((a, b) => a.name.localeCompare(b.name));
        }

        async function fetchJsonFile(year, month, filename) {
            const baseUrl = new URL('.', window.location.href).href;
            const url = `${baseUrl}${year}/${month}/${filename}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`Fetch failed (${res.status})`);
            return res.json();
        }

        function renderDayCard(filename, payload) {
            const dateLabel = filename.replace('.json', '');
            const executedAt = payload?.executed_at || 'Unknown';
            const data = Array.isArray(payload?.data) ? payload.data : [];

            const card = document.createElement('article');
            card.className = 'day-card';

            const header = document.createElement('h2');
            header.textContent = dateLabel;
            card.appendChild(header);

            const meta = document.createElement('p');
            meta.style.color = 'var(--muted)';
            meta.style.margin = '0 0 8px';
            meta.textContent = `Executed at: ${executedAt}`;
            card.appendChild(meta);

            if (!data.length) {
                const empty = document.createElement('p');
                empty.textContent = 'No releases for this day.';
                card.appendChild(empty);
            } else {
                data.forEach(item => {
                    const release = document.createElement('div');
                    release.className = 'release';

                    const title = document.createElement('h3');
                    title.textContent = item.tag || 'Untitled release';
                    release.appendChild(title);

                    const time = document.createElement('time');
                    time.textContent = item.published_at || 'Unknown time';
                    release.appendChild(time);

                    if (item.body) {
                        const body = document.createElement('p');
                        body.innerHTML = renderBodyHtml(item.body);
                        release.appendChild(body);
                    }

                    card.appendChild(release);
                });
            }

            resultsEl.appendChild(card);
        }

        function renderErrorCard(filename, err) {
            const card = document.createElement('article');
            card.className = 'day-card';
            const header = document.createElement('h2');
            header.textContent = filename.replace('.json', '');
            card.appendChild(header);
            const msg = document.createElement('p');
            msg.textContent = `Load failed: ${err.message}`;
            card.appendChild(msg);
            resultsEl.appendChild(card);
        }

        async function listYears() {
            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${docsPath}?ref=${branch}`;
            const res = await fetch(apiUrl, { headers: { 'Accept': 'application/vnd.github+json' } });
            if (!res.ok) throw new Error(`GitHub API error (${res.status})`);
            const data = await res.json();
            if (!Array.isArray(data)) return [];
            return data
                .filter(item => item.type === 'dir' && /^\d{4}$/.test(item.name))
                .map(item => item.name)
                .sort();
        }

        async function listMonths(year) {
            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${docsPath}/${year}?ref=${branch}`;
            const res = await fetch(apiUrl, { headers: { 'Accept': 'application/vnd.github+json' } });
            if (res.status === 404) return [];
            if (!res.ok) throw new Error(`GitHub API error (${res.status})`);
            const data = await res.json();
            if (!Array.isArray(data)) return [];
            return data
                .filter(item => item.type === 'dir' && /^\d{2}$/.test(item.name))
                .map(item => item.name)
                .sort();
        }

        function setActiveButton(button) {
            if (activeButton) activeButton.classList.remove('active');
            activeButton = button;
            if (activeButton) activeButton.classList.add('active');
        }

        async function buildSidebar() {
            setStatus('Loading months...');
            sidebarEl.innerHTML = '';

            let years = [];
            try {
                years = await listYears();
            } catch (err) {
                setStatus(`Load failed: ${err.message}`);
                return null;
            }

            if (!years.length) {
                setStatus('No data');
                sidebarEl.innerHTML = '<div class="empty">No year directories found.</div>';
                return null;
            }

            const monthIndex = {};
            for (const year of years) {
                const months = await listMonths(year);
                monthIndex[year] = months;

                const group = document.createElement('div');
                group.className = 'year-group';

                const title = document.createElement('h3');
                title.textContent = year;
                group.appendChild(title);

                const list = document.createElement('div');
                list.className = 'month-list';

                if (!months.length) {
                    const empty = document.createElement('p');
                    empty.textContent = 'No months available.';
                    empty.style.color = 'var(--muted)';
                    empty.style.margin = '0 0 8px';
                    group.appendChild(empty);
                } else {
                    months.forEach(month => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'month-chip';
                        btn.textContent = month;
                        btn.addEventListener('click', () => {
                            setActiveButton(btn);
                            loadMonth(year, month);
                        });
                        list.appendChild(btn);
                    });
                    group.appendChild(list);
                }

                sidebarEl.appendChild(group);
            }

            const latestYear = years[years.length - 1];
            const latestMonths = monthIndex[latestYear] || [];
            if (!latestMonths.length) {
                setStatus('No months available');
                return null;
            }

            const latestMonth = latestMonths[latestMonths.length - 1];
            const latestButton = Array.from(sidebarEl.querySelectorAll('.year-group'))
                .find(group => group.querySelector('h3')?.textContent === latestYear)
                ?.querySelectorAll('.month-btn')?.[latestMonths.length - 1];

            if (latestButton) setActiveButton(latestButton);
            return { year: latestYear, month: latestMonth };
        }

        (async () => {
            const latest = await buildSidebar();
            if (latest) {
                await loadMonth(latest.year, latest.month);
            }
        })();
    </script>
</body>

</html>